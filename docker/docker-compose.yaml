---
version: "3.8"
services:
  fedbox:
    image: quay.io/fedbox/fedbox:${ENV:-dev}
    command: /bin/fedbox --env ${ENV:-dev}
    expose:
    - 4000
    environment:
    - ENV=${ENV:-dev}
    - LISTEN=:4000
    volumes:
    - /tmp:/storage
    - ./.env:/.env
    depends_on:
    - bootstrap
  bootstrap:
    build:
      context: bootstrap
      args:
      - HOSTNAME=${HOSTNAME:-brutalinks.docker.git}
      - ENV=${ENV:-dev}
      - OAUTH_PW=${OAUTH_PW}
      - ADMIN_PW=${ADMIN_PW}
    command: /bin/bootstrap.sh && echo /.env
    volumes:
    - /tmp:/storage
    - ./.env:/.env
  lb:
    image: caddy
    ports:
    - 8443:443
    links:
    - app
    - fedbox
    volumes:
    - ./Caddyfile:/etc/caddy/Caddyfile
  app:
    image: quay.io/fedbox/littr:${ENV:-dev}
    volumes:
    - ./.env:/.env
    expose:
    - 4001
    links:
    - fedbox
#    - redis
#    - es
    command: /bin/littr -host ${HOSTNAME} -port 4001 -env ${ENV:-dev}
